<!doctype html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">

<head>

<title>Augur</title>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/css/bootstrap.css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.min.css" />

<link href='http://fonts.googleapis.com/css?family=Roboto:400,400italic,300,300italic,700italic,700' rel='stylesheet' type='text/css'>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    
<style>

body {
    font-family: 'Roboto', sans-serif;
    font-weight: 200;
}
h1, h2, h3, h4, h5 {
    font-family: 'Roboto', sans-serif;
    font-weight: 200;
}
h3 {
    margin: 5px 0px 10px 0px;
}
h3 span {
    font-size: 14px;
    margin-top: 10px;
}
h4 a,
h4 span {
    font-size: 14px;
    margin-top: 3px;
}
table {
    font-size: 12px;
}
table thead th{
    font-weight: 400;
}
nav h1 {
    font-size: 24px;
    font-weight: 200;
    margin: 0px 0px 0px 0px;
}
nav h1 span {
    font-weight: 400;
}
nav .cash {
    margin-left: 20px;
    font-weight: bold;
}

.nav button {
    margin-top: 7px;
}
.nav .btn-danger .status:before {
    content: 'Node stopped';
}
.nav .btn-warning .status:before {
    content: 'Node starting';
}
.nav .btn-success .status:before {
    content: 'Node running';
}
.nav span.glyphicon-cog {
    font-size: 16px;
    margin-left: 8px;
    position: relative;
    top: 3px;
}

.sidebar .panel {
    font-size: 12px;
}

.branches .branches-toggle:before {
    content: 'show all';
}
.branches.all .branches-toggle:before {
    content: 'less';
}
.branches .other {
    display: none;
}
.branches.all .other {
    display: block;
}
#start-node,
#stop-node {
    margin-top: 0px;
}
#node-settings-modal .modal-dialog {
    font-size: 14px;
    width: 350px;
}
#node-settings-modal legend {
    font-size: 14px;
}
#node-settings-modal label {
    font-weight: 200;
    font-size: 12px;
    position: relative;
    top: 0px;
    right: -16px;
}
#create-branch-modal .modal-dialog {
    width: 400px;
}
#explore-modal .modal-dialog {
    width: 90%;
}
#explore-modal pre {
    border-top-left-radius: 0;
    border-top-right-radius: 0;
    font-size: 12px;
    margin: 0px;
}
#explore-modal .input-group {
    width: 250px;
}
#send-cash-modal #dest-address {
    width: 290px;
}
.address {
    overflow: hidden;
    text-overflow: ellipsis;
}
.network .miner-off span {
    color: red;
}
.network .miner-on span {
    color: green;
    font-weight: bold;
}
.network .blocks {
    margin-bottom: 15px;
}
.network fieldset {
    margin-top: 15px;
}
.network fieldset legend {
    font-size: 12px;
    margin-bottom: 10px;
}
.reporting {
    display: none;
    margin-bottom: 30px;
}
.reporting #report-decisions {
    margin-bottom: 0px;
}
.reporting #report-decisions li {
    background-color: rgb(255, 255, 228);
}
.reporting #report-decisions li:last-child {
    border-bottom-right-radius: 0; 
}
.reporting p,
.reporting label {
    font-size: 14px;
}
.reporting button[type=submit] {
    position: relative;
    top: -1px;
    border-top-left-radius: 0;
    border-top-right-radius: 0;
}
.reporting #reveal-button {
    display: none;
}
.reporting .my-choice {
    display: none;
    font-weight: bold;
    margin-bottom: 0px;
}
.reporting.reported #report-button {
    display: none;
}
.reporting.reported #reveal-button {
    display: inline-block;
}
.reporting.reported .my-choice {
    display: block;
}
.reporting.reported label {
    display: none;
}

.spin {
    display: inline-block;
    -webkit-transform-origin: 47% 50%;
    transform-origin: 47% 50%;
    -webkit-animation: spin 1s infinite linear;
    -moz-animation: spin 1s infinite linear;
    -o-animation: spin 1s infinite linear;
    animation: spin 1s infinite linear;
}
#alert {
    padding: 10px;
    position: fixed;
    width: 100%;
    min-height: 40px;
    opacity: 0.8;
    bottom: 0;
    margin-bottom: 0px;
    border-radius: 0;
    display: none;
}
#alert div {
    max-height: 60px;
    overflow-y: scroll;
}
#alert div p {
    font-size: 13px;
    margin-bottom: 5px;
}
</style>

<body>

    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <h1 class="navbar-brand"><span>Augur</span></h1>
            </div>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <button class="btn btn-danger" data-toggle="modal" data-target="#node-settings-modal">
                        <span class="status"></span>
                        <span class="glyphicon glyphicon-cog"></span>
                    </button>
                </li>
            </ul>
        </div>
        
    </nav>

    <section id="main" class="container" style="display:none;">

        <div class="dash page row">

            <div class="col-sm-3 sidebar">
                <div class="panel panel-success account">
                    <div class="panel-heading clearfix">Account</div>
                    <div class="panel-body">
                        <p class="address"></p>
                        <p class="cash"></p>       
                    </div>
                </div>

                <div class="panel panel-info">
                    <div class="panel-heading clearfix"><span class="pull-left">Branches</span><a class="pull-right" href="#create-branch-modal" data-toggle="modal">create</a></div>
                    <div class="panel-body branches">
                    </div>
                </div>

                <div class="panel panel-default network">
                    <div class="panel-heading clearfix"><span class="pull-left">Network</span></div>
                    <div class="panel-body">
                        <p class="blocks clearfix"></p>
                        <p class="miner-control miner-off clearfix"><span class="pull-left">MINER OFF</span><a href="#" class="pull-right">start</a></p>
                        <p class="miner-control miner-on clearfix" style="display:none;"><span class="pull-left">MINER ON</span><a href="#" class="pull-right">stop</a></p>
                        <fieldset>
                            <legend>PEERS</legend>
                            <div class="peers"></div>
                        </fieldset>
                    </div>
                </div>

            </div>
          
            <div class="col-sm-9">
                
                <div class="reporting">
                    <h3 class="clearfix"></h3>
                    <form method='POST' class="clearfix" id="report" style="display: none;">
                        <ul class="list-group" id="report-decisions"></ul>
                        <script type="text/template" id="report-template">
                            <li class="list-group-item">
                                <p><%= d.txt %></p>
                                <label class="radio-inline"><input type="radio" name="<%= d.decision_id %>" value='yes'>True</label>
                                <label class="radio-inline"><input type="radio" name="<%= d.decision_id %>" value='no'>False</label>
                                <label class="radio-inline"><input type="radio" name="<%= d.decision_id %>" value='unknown'>
                                    Ambiguous or Indeterminent
                                </label>
                                <p class="my-choice"><%= d.my_choice %></p>
                            </li>
                        </script>
                        <button type="submit" class="btn btn-primary pull-right" id="report-button">SUBMIT REPORT</button>
                        <button type="submit" class="btn btn-success pull-right" id="reveal-button">REVEAL REPORT</button>
                        <p id="error" class="hidden pull-right"></p>
                    </form>
                </div>

                <h4 class="clearfix">Decisions <a href="#add-decision-modal" data-toggle="modal" class="pull-right">Add decision</a>
                </h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Description</th><th>Branch</th><th>Matures</th><th style="text-align: right;">Trade</th>
                        <tr>
                    </thead>
                    <tbody class="decisions"></tbody>
                </table>
            </div>
        </div>

    </section>

    <footer>

        <div class="row container clearfix">

        </div>

    </footer>

    <div id="alert" class="alert alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <div></div>
    </div>

    <!-- modals dialogs -->

    <div id="password-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-body clearfix">
                    <form method="POST">
                        <div class="col-lg-12">
                            <div class="input-group">
                                <input type="password" name="password" class="form-control" placeholder="Enter your password or public key" autofocus>
                                <span class="input-group-btn">
                                    <button class="btn btn-success" type="submit">Start</button>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="create-branch-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <p>Create a new branch by entering a unique ID.  You will automatically be added to this branch and awarded all reputation to start.</p>
                </div>
                <div class="modal-body clearfix">
                    <form>
                        <div class="col-lg-12">
                            <div class="input-group">
                                <input type="text" name="branch-id" id="branch-id" class="form-control" placeholder="Enter a branch ID">
                                <span class="input-group-btn">
                                    <button class="btn btn-primary" type="submit">Create branch</button>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="send-cash-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Send cash</h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline" role="form">
                        <div class="form-group">
                            <label class="sr-only" for="dest-address">Destination address</label>
                            <input type="text" class="form-control" name="cash-dest-address" id="cash-dest-address" placeholder="Enter destination address">
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="amount">Amount</label>
                            <input type="text" name="cash-amount" id="cash-amount" class="form-control" placeholder="Amount">
                        </div>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="send-rep-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Send <span class="branch"></span> reputation</h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline" role="form">
                        <div class="form-group">
                            <label class="sr-only" for="dest-address">Destination address</label>
                            <input type="text" class="form-control" name="rep-dest-address" id="rep-dest-address" placeholder="Enter destination address">
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="amount">Amount</label>
                            <input type="text" name="rep-amount" id="rep-amount" class="form-control" placeholder="Amount">
                        </div>
                        <input type="hidden" name="rep-branch" id="rep-branch">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="trade-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h4><span class="trade-type"></span> shares of <span class="market"></span></h4>
                </div>
                <div class="modal-body">
                    <form class="form-inline" role="form">
                        <div class="form-group">
                            <label class="sr-only" for="market-state">State</label>
                            <div id="market-state"></div>
                        </div>
                        <div class="form-group">
                            <label class="sr-only" for="amount">Amount</label>
                            <input type="text" name="trade-amount" id="trade-amount" class="form-control" placeholder="Amount">
                        </div>
                        <input type="hidden" name="trade-type" id="trade-type">
                        <input type="hidden" name="trade-market" id="trade-market">
                        <button type="submit" class="btn btn-primary"><span class="trade-type"></span></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="add-decision-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h4>Add decision</h4>
                </div>
                <div class="modal-body clearfix">
                    <form role="form">
                        <div class="form-group">
                            <label for="decision-branch">Branch</label>
                            <select class="form-control branches" id="decision-branch" name="decision-branch"></select>
                        </div>
                        <div class="form-group">
                            <label for="decision-text">Decision text</label>
                            <input type="text" class="form-control" id="decision-text" placeholder="Enter a true or false question">
                        </div>
                        <div class="form-group">
                            <label for="decision-date">Maturation block</label>
                            <input type="text" class="form-control" id="decision-time" placeholder="Enter block number that decision matures">
                        </div>
                        <div class="form-group">
                            <label for="market-investment">Initial investment</label>
                            <input type="text" class="form-control" id="market-investment" placeholder="Your initial investment (in cash)">
                        </div>
                        <button type="submit" class="btn btn-primary pull-right">Submit Decision</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="node-settings-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button id="stop-node" class="btn btn-danger btn-block" data-loading-text="Stopping..." style="display: none;">Stop node</button>
                    <button id="start-node" class="btn btn-success btn-block" data-loading-text="Starting...">Start node</button>
                    <form id="password-form" style="display: none;">
                        <div class="input-group">
                            <input type="text" class="form-control" id="password" placeholder="Enter password or address">
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="sumbit">Start</button>
                            </span>
                        </div>
                    </form>
                </div>
                <div class="modal-body clearfix">
                    <form class="form-horizontal" role="form">
                        <div class="form-group">
                            <label for="node-host" class="col-sm-4 control-label">Host</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control input-sm" id="node-host" placeholder="Host">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="node-port" class="col-sm-4 control-label">Port</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control input-sm" id="node-port" placeholder="Port">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="core-path" class="col-sm-4 control-label">Augur path</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control input-sm" id="core-path" placeholder="Path to Augur core">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary pull-right btn-sm">SAVE SETTINGS</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="explore-modal" class="modal fade">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header clearfix">
                    <form class="row">
                        <div class="col-lg-6">
                            <div class="input-group input-group-sm">
                                <input type="text" name="block-number" class="form-control" placeholder="Enter block number">
                                <span class="input-group-btn">
                                    <button class="btn btn-info" type="submit">View</button>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
                <pre class="block-view"></pre>
            </div>
        </div>
    </div>  

    <div id="na-modal" class="modal fade">
        <div class="modal-dialog model-sm">
            <div class="modal-content">
                <div class="modal-body">
                    <h4 class="text-center">Not yet implemented</h4>
                </div>
            </div>
        </div>
    </div>


<script id="nodeMonitor" type="javascript/worker">

    console.log('[nodeMonitor] starting');

    importScripts("http://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js");
    importScripts("http://cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js");

    var socket = io.connect(location.origin + '/socket.io/')

    var SECONDS_PER_BLOCK = 60;
    var REPORT_CYCLE = 40;

    var augur = {
        decisions: {},
        branches: {},
        markets: {},
        blockcount: 0,
        network_blockcount: 0,
        running: false,
        starting: false,
        market_queue: {}
    }

    var cycle = {
        count: 0,
        decisions: {}
    };

    var account = {};

    function blockTime(block) {   // estimates time of given block

        var d = new Date();
        var seconds_diff = (block - augur.network_blockcount) * SECONDS_PER_BLOCK;
        d.setSeconds(d.getSeconds() + seconds_diff);

        return d;
    }

    socket.on('account', function (data) { 

        account = _.extend(account, data)

        self.postMessage({'address': account.address});
        self.postMessage({'cash': account.cash});
        //self.postMessage({'branches': augur.branches});
        //self.postMessage({'shares': account.shares});
    });

    socket.on('miner', function (data) { 
        self.postMessage({'miner': data});
    });

    socket.on('blockcount', function (count) {

        if (augur.blockcount != count) {

            var prev_blockcount = augur.blockcount;
            var start_block = prev_blockcount + 1

            augur.blockcount = count;
            self.postMessage({'blockcount': count});

            socket.emit('update-account');
            console.log('[nodeMonitor] fetching blocks '+ start_block +' - '+augur.blockcount);

            // examine new blocks
            for (i = start_block; i <= augur.blockcount; i++) {
                socket.emit('get-block', i);
            }

            // check for maturing decisions
            _.each(augur.decisions, function(d) {
                if (d['status'] == 'open' && d['maturation'] >= augur.network_blockcount) {
                    d['status'] == 'closed';
                }
            });

            // check cycle reporting phase
            cycle_count = parseInt(augur.network_blockcount / REPORT_CYCLE);
            cycle_blockcount = augur.network_blockcount - (cycle_count * REPORT_CYCLE);

            // reporting phase
            if (cycle_count != cycle['count']) {   // we're in a new cycle

                old_cycle_count = cycle['count'];

                cycle['count'] = cycle_count;
                cycle['reported'] = false;
                cycle['phase'] = 'reporting';

                console.log("[nodeMonitor] reporting cycle " + cycle['count']);

                cycle['end_block'] = (cycle_count + 1) * REPORT_CYCLE;
                cycle['end_date'] = blockTime((cycle_count + 1) * REPORT_CYCLE);

                if (cycle_count != 0) {

                    cycle['last_end_block'] = cycle_count * REPORT_CYCLE;
                    cycle['last_end_date'] = blockTime(cycle_count * REPORT_CYCLE);

                    // collect reporting decisions
                    _.each(augur.decisions, function(d) {

                        cycle['decisions'] = {};

                        if (d['status'] == 'closed' && _.has(account['branches'], d['vote_id'])) {
                            cycle['decisions'][d['decision_id']] = d;
                        };
                    });
                }

            // reveal phase
            } else if (cycle_blockcount > REPORT_CYCLE * 0.875 && cycle_blockcount < REPORT_CYCLE * 0.975 && cycle['phase'] != 'reveal') {   

                cycle['phase'] = 'reveal';

                // reveal votes if reported
                if (cycle['reported']) {

                    _.each(cycle['decisions'], function(d) {

                        socket.emit('reveal-vote', d['vote_id'], d['decision_id']);
                        console.log('[nodeMonitor] revealing vote ('+d['decision_id']+') in '+d['vote_id']);

                        self.postMessage({'report': cycle});
                    });
                }

            // SVD phase
            } else if (cycle_blockcount >= REPORT_CYCLE * 0.975 && cycle['phase'] != 'svd') {

                cycle['phase'] = 'svd';

                // collect all branches voted on
                branches = {}

                _.each(cycle['decisions'], function(d) {

                    branches[d['vote_id']] = true;

                    // dedupe list and do SVD concensus on all voted branches
                    _.each(branches.keys(), function(branch) {

                        socket.emit('svd-consensus', branch);
                        console.log('[nodeMonitor] svd consensus for ' + branch);

                    });
                });
            }

            // update reporting
            self.postMessage({'report': cycle});
        }
    });

    socket.on('block', function (block) {

        if (block && block['txs']) {

            var messages = []

            _.each(block['txs'], function(tx) {

                // build ledger of all account transactions
                if (tx['pubkey'] == account['pubkey']) acount['txs'].push(tx);

                if (tx['type'] == 'propose_decision') {

                    tx['status'] = tx['maturation'] > augur.network_blockcount ? 'open' : 'closed';
                    augur.decisions[tx['decision_id']] = tx;

                    // check to see if we're waiting for this decision to show up
                    if (augur.market_queue[tx['decision_id']]) {

                        socket.emit('add-market', augur.market_queue[tx['decision_id']]);
                        delete account.branches[tx.vote_id];
                    }

                    messages.push('New decision added: ' + tx['txt'] + ' (' + tx['decision_id'] + ')');

                } else if (tx['type'] == 'prediction_market') {

                    augur.markets[tx['PM_id']] = tx;

                    // add extra decision data
                    var decision_id = tx['decisions'][0];
                    augur.markets[tx['PM_id']]['txt'] = augur.decisions[decision_id]['txt'];
                    augur.markets[tx['PM_id']]['vote_id'] = augur.decisions[decision_id]['vote_id'];
                    augur.markets[tx['PM_id']]['maturation'] = augur.decisions[decision_id]['maturation'];
                    augur.markets[tx['PM_id']]['maturation_date'] = blockTime(augur.decisions[decision_id]['maturation']);
                    augur.markets[tx['PM_id']]['status'] = augur.decisions[decision_id]['status'];

                    self.postMessage({'markets': augur.markets});
                    messages.push('New market added: ' + tx['PM_id']);

                } else if (tx['type'] == 'create_jury') {

                    augur.branches[tx.vote_id] = tx;

                    // check to see if we have any rep on this branch
                    if (_.has(account.branches, tx.vote_id)) {
                        augur.branches[tx.vote_id]['my_rep'] = account.branches[tx.vote_id];
                    }

                    self.postMessage({'branches': augur.branches});
                    messages.push('New branch added: ' + tx['vote_id']);

                } else if (tx['type'] == 'spend') {

                    sender = 'unknown';
                    if (tx.vote_id) {
                        messages.push(sender + ' sent ' + tx['amount'] + ' ' + tx['vote_id'] + ' reputation to ' + tx['to']);
                    } else {
                        messages.push(sender + ' sent ' + tx['amount'] + ' cash to ' + tx['to']);
                    }

                }
            });

            if (messages.length) self.postMessage({'alert': {'type': 'info', 'messages': messages}});
        }      
    });

    socket.on('peers', function (peers) {

        if (!augur.running) {
            socket.emit('get-account');
            augur.running = true;

            self.postMessage({'node-up': true});            
        }

        _.each(peers, function(data) {

            // update network blockcount to largest peers
            augur.network_blockcount = data.blockcount > augur.network_blockcount ? data.blockcount : augur.network_blockcount;
        });

        self.postMessage({'peers': peers});
    });

    socket.on('node-down', function() {

        // check to see if we were already running
        if  (augur.running) {

            self.postMessage({'node-down': true});   
            augur.running = false;
        }
    });

    self.addEventListener('message', function(message) {

        var m = message.data;

        if (m && m['add-decision']) {

            var tx = {
                'txt': m['add-decision']['decisionText'],
                'decision_id': m['add-decision']['decisionId'],
                'vote_id': m['add-decision']['branchId'],
                'maturation': m['add-decision']['decisionMaturation'],
                'status': 'pending'
            }

            augur.decisions[tx.decision] = tx;

            var tx = {
                'B': parseInt(m['add-decision']['marketInv']),
                'PM_id': m['add-decision']['decisionId'] + '.market',
                'decisions': [m['add-decision']['decisionId']],
                'fees': 0,
                'owner': account.address,
                'states': ['no', 'yes'],
                'type': 'prediction_market',
                'txt': m['add-decision']['decisionText'],
                'vote_id': m['add-decision']['branchId'],
                'maturation': m['add-decision']['decisionMaturation'],
                'maturation_date': blockTime(m['add-decision']['decisionMaturation']),
                'status': 'pending'
            }

            augur.markets[tx.PM_id] = tx;
            self.postMessage({'markets': augur.markets});

            augur.market_queue[m['add-decision'].decisionId] = m['add-decision'];
        }
    });

    // start pinging node for updates
    setInterval(function() { socket.emit('ping') }, 2500);

</script>

<script>
(function () {

    var socket = io.connect(location.origin + '/socket.io/');

    function formatDate(d) {

        months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Oct','Sep','Nov','Dec'];

        var hour = d.getHours() > 11  ? d.getHours() - 12 : d.getHours();
        hour = hour == 0 ? 12 : hour;
        var apm = d.getHours() > 10 || d.getHours() == 23 && d.getHours() != 0 ? 'pm' : 'am';
        var minutes = d.getMinutes() < 10 ? '0'+ d.getMinutes() : d.getMinutes();
  
        return months[d.getMonth()]+' '+d.getDate()+', '+hour+':'+minutes+' '+apm;
    }

    // define node monitoring web worker from script block above and start it
    var blob = new Blob([document.querySelector('#nodeMonitor').textContent]);
    var nodeMonitor = new Worker(window.URL.createObjectURL(blob));

    // worker error handling
    nodeMonitor.addEventListener('error', function(e) {
        console.log('[nodeMonitor] error on '+ e.lineno,': ' +e.message);
    }, false);

    // main worker postMessage listener
    nodeMonitor.addEventListener('message', function(e) {
    
        var m = e.data;

        if (m['alert']) {

            $('#alert').removeClass('alert-info').removeClass('alert-success').removeClass('alert-warning').removeClass('alert-danger');
            $('#alert').addClass('alert-'+m.alert['type']);

            items = [];
            _.each(m.alert['messages'], function(message) {
                items.push($('<p>').html(message));
            });
            $('#alert div').append(items);
            $('#alert div').scrollTop($('#alert div')[0].scrollHeight);
            $('#alert').show();

        } else if (m['node-up']) {

            $('#main').show();
            $('#node-settings-modal').modal('hide');
            $('.nav button').addClass('btn-success')
            $('.nav button').removeClass('btn-warning')
            $('.nav button').removeClass('btn-danger')
            $('#node-settings-modal .btn-success').hide();
            $('#node-settings-modal .btn-danger').show();
            $('#start-node').button('reset');

        } else if (m['node-starting']) {

            $('.nav button').removeClass('btn-success');
            $('.nav button').addClass('btn-warning');
            $('.nav button').removeClass('stopped');
            //$('#main').show();   // show the dash while starting up or not?

        } else if (m['node-down']) {

            $('#main').hide();
            $('#node-settings-modal').modal('hide');
            $('.nav button').removeClass('btn-success');
            $('.nav button').removeClass('btn-danger');
            $('.nav button').addClass('btn-danger');
            $('#node-settings-modal .btn-success').show();
            $('#node-settings-modal .btn-danger').hide();
            $('#stop-node').button('reset');

        } else if (m['peers']) {

            $('.peers').empty();

            $.each(m['peers'], function(address, info) {
                var p = $('<p>').text(address);
                $('.peers').append(p);
            });

        } else if (m['report']) {

            if (!$.isEmptyObject(m['report']['decisions'])) {

                $('#report').show();

                $('.reporting h3').html('Reporting <span class="pull-right">Cycle ending ' + formatDate(m['report'].last_end_date) + '</span>');

                if (m['report'].reported && !m['report'].phase) {
                    $('.reporting').addClass('reported');
                    $('#reveal-button').attr('disabled', 'true');
                } else if (m['report'].phase == 'reporting') {
                    $('.reporting').removeClass('reported');
                    $('#reveal-button').removeAttr('disabled');
                }

                $('#report-decisions').empty();

                var template = _.template($("#report-template").html());
                _.each(m['report']['decisions'], function(d, id) {
                    $('#report-decisions').append(template({'d': d}));
                });

            } else {

                $('#report').hide();

                $('.reporting h3').html('Cycle ending ' + formatDate(m['report'].end_date));
            }

            $('.reporting').show();
 
        } else if (m['branches']) {

             if (!$.isEmptyObject(m['branches'])) {

                $('.branches').empty()

                // sort on reputation
                //m['branches'] = m['branches'].sort(function(a,b) {return (a.my_rep > b.my_rep) ? -1 : ((b.my_rep > a.my_rep) ? 1 : 0);} );
                var has_branches = false;

                _.each(m['branches'], function(branch) {

                    m['branches'][branch['vote_id']] = branch;   // update local branches

                    // update add decision modal
                    $('#decision-branch').append($('<option>').val(branch.vote_id).text(branch.vote_id));

                    if (branch.my_rep) {

                        has_branches = true;
                        var p = $('<p>').html('<span class="pull-left"><b>'+branch.vote_id+'</b> ('+branch.my_rep+')</span>').addClass('clearfix');
                        var send = $('<a>').attr('href','#').addClass('pull-right').text('send').on('click', function() {
                            $('#rep-branch').val(branch.vote_id);
                            $('#send-rep-modal .branch').text(branch.vote_id);
                            $('#send-rep-modal').modal('show');
                        })
                        p.append(send);

                    } else {
                        var p = $('<p class="other">').html('<span>'+branch.vote_id+'</span>');
                    }
                    $('.branches').append(p);
                });

                var bt = $('<a>').addClass('pull-right branches-toggle').on('click', function(event) {
                    $('.branches').toggleClass('all');
                });
                $('.branches').append(bt);

            } else {

                var p = $('<p>').html('<span class="pull-left">There are no branches</span>');
                $('.branches').empty().append(p);
            }

        } else if (m['address']) {

            $('.address').html(m['address']);

        } else if (m['blockcount']) {

            $('.blocks').html('<span class="pull-left"><b>'+m['blockcount']+'</b> BLOCKS</span><a class="pull-right" href="#explore-modal" data-toggle="modal">explore</a>');

        } else if (m['view-block']) {

            $('.block-view').text(m['view-block']);

        } else if (m['markets']) {

            if (!$.isEmptyObject(m['markets'])) {

                $('.decisions').empty();
                _.each(m['markets'], function(m) {

                    var states = $('<select>').addClass('states, form-control').attr('name', 'market-state');
                    _.each(m['states'], function(state) {
                        states.append($('<option>').val(state).text(state));
                    });
                    var row = $('<tr>').html('<td>'+m.txt+'</td><td>'+m.vote_id+'</td><td>'+formatDate(m.maturation_date)+'</td>');
                    var buy = $('<a>').attr('href', '#').text('buy').on('click', function() {
                        $('#trade-modal .trade-type').text('buy');
                        $('#trade-modal .market').text(m.PM_id);
                        $('#trade-market').val(m.PM_id);
                        $('#trade-type').val('buy');
                        $('#trade-modal').modal('show');
                        $('#market-state').empty().append(states);
                    });
                    var sell = $('<a>').attr('href', '#').text('sell').on('click', function() {
                        $('#trade-modal .trade-type').text('sell');
                        $('#trade-modal .market').text(m.PM_id);
                        $('#trade-market').val(m.PM_id);
                        $('#trade-type').val('sell');
                        $('#trade-modal').modal('show');
                        $('#market-state').empty().append(states);
                    });
                    if (m.status == 'open') {
                        var trade = $('<td>').append(buy).append(' / ').append(sell).css('text-align', 'right');
                    } else if (m.status == 'pending') {
                        var trade = $('<td>').text('pending').css('text-align', 'right');
                    } else {
                        var trade = $('<td>').text('closed').css('text-align', 'right');
                    }
                    $(row).append(trade);
                    $('.decisions').append(row);
                });
            }

        } else if (m['miner']) {

            if (m['miner'] == 'on') {

                $('.miner-off').hide();
                $('.miner-on').show()

            } else {

                $('.miner-on').hide()
                $('.miner-off').show();
            }

        } else if (m['cash']) {

            $('.cash').html('<span class="pull-left"><b>'+m['cash']+'</b> CASH</span><a class="pull-right" href="#send-cash-modal" data-toggle="modal">send</a>');
        }

    }, false);

    // start worker
    nodeMonitor.postMessage();

    ////
    // actions

    $('.miner-control a').on('click', function() {

        if ($('.miner-off').is(':visible')) {

            socket.emit('miner', 'start');
            
        } else if ($('.miner-on').is(':visible')) {

            socket.emit('miner', 'stop');
        }
    });

    $('#password-form').on('submit', function(event) {

        event.preventDefault();
        socket.emit('start', $('#password').val());
        $(this).hide();
        $('#start-node').button('loading');
        $('#start-node').show();
        $('#password-modal').modal('hide');
    }); 


    $('.reporting form').on('submit', function(event) {

        event.preventDefault();

        var results = $(this).serializeArray();

        _.each(results, function(r, i) {
            results[i]['branch'] = _decision[r.name].vote_id;
        });

        socket.emit('report', results);
    }); 


    $('#create-branch-modal form').on('submit', function(event) {

        event.preventDefault();
        socket.emit('create-branch', $('#branch-id').val());
        $('#create-branch-modal').modal('hide');
    });

    $('#add-decision-modal form').on('submit', function(event) {

        event.preventDefault();

        var args = {
            'branchId': $('#decision-branch').val(),
            'decisionText': $('#decision-text').val(),
            'decisionMaturation': $('#decision-time').val(),
            'marketInv': $('#market-investment').val()
        }

        socket.emit('add-decision', args);
        $('#add-decision-modal').modal('hide');
    });

    socket.on('add-decision', function(data) {
        nodeMonitor.postMessage({'add-decision': data});
    });

    $('#send-cash-modal form').on('submit', function(event) {

        event.preventDefault();
        var address = $('#cash-dest-address').val();
        var amount = $('#cash-amount').val();
        socket.emit('send-cash', address, amount);
        $('#send-cash-modal').modal('hide');
    });

    $('#trade-modal form').on('submit', function(event) {

        event.preventDefault();
        var args = {
            'marketId': $('#trade-market').val(),
            'marketState': $('#market-state select').val(),
            'tradeAmount': $('#trade-amount').val(),
            'tradeType': $('#trade-type').val()
        }
        socket.emit('trade', args);
        $('#trade-modal').modal('hide');
    });

    $('#send-rep-modal form').on('submit', function(event) {

        event.preventDefault();
        var address = $('#rep-dest-address').val();
        var amount = $('#rep-amount').val();
        var branch = $('#rep-branch').val();
        
        socket.emit('send-reps', address, amount, branch);
        $('#send-rep-modal').modal('hide');
    });

    $('#explore-modal form').on('submit', function(event) {

        event.preventDefault();
        socket.emit('explore-block', $('#explore-modal input[name=block-number]').val());
    });

    socket.on('show-block', function(data) {
        $('#explore-modal pre').text(data);
    });


    $('#stop-node').on('click', function() {
        $(this).button('loading');
        socket.emit('stop');
    });

    $('#start-node').on('click', function() {
        $(this).hide();
        $('#password-form').show();
        $('#password').focus();
    });

    $('#alert').on('closed.bs.alert', function() {
        $('#alert div').empty();
    });

})()
</script>

</body>
</html>